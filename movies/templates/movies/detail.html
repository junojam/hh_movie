{% extends 'base.html' %}

{% block detail %}
<div class="backgroundimagesetting">
    <!-- <div> -->
    <br>
    <div class="container" style="padding: 12px; background-color: #ffffff;">
        <iframe width="100%" height="600px" src="{{ movie.video_url }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        <hr> 

        <div class="d-flex flex-row justify-content-start align-items-start">
            <img class="items me-3 mt-3" width="480px" height="720px" src="https://www.themoviedb.org/t/p/original{{ movie.poster_path }}" alt="">
            <div class="">
                <br>
                <div class="item d-flex flex-row justify-content-between align-items-center">
                    <h2 class="item align-items-center">{{ movie.title }} <span class="ms-2 btn btn-success" style="cursor:default">{{movie.vote_average}}</span></h2>
                    <h5 class="item align-items-center me-3">{{ movie.genre }}</h5>
                </div>
                <hr>
                <div>개봉일 : {{ movie.release_date}}</div>
                <br>
                <h5 class="item" >{{ movie.overview }}</h5>
                <br>
                <div>
                    <h4>감독</h4>
                    <hr>
                    <div class="d-flex flex-row justify-content-start fw-bold">
                        {% for director in directors %}
                        {% if director.movie_id == movie.id %}
                        <div class="d-flex">
                            <div class="item" style="margin:10px;">
                                {% load static %}
                                <img width="135px" src="https://www.themoviedb.org/t/p/original{{director.profile_path}}" onerror="this.src=`{% static 'movies/ALT_IMAGE.png' %}`" alt="">
                                <div style="width:135px; text-align:center; word-break:normal; " class="text-center text-dark">{{director.name}}</div>
                                <!-- <div style="width:160px; text-align:center; word-break:normal; " class="text-center text-dark">{{director.department}}</div> -->
                            </div>
                        </div>
                        {% if user.id %}
                        <div>
                            <form class="dlike-form" data-director-id="{{ director.pk }}">
                                {% csrf_token %}
                                {% if user in director.like_users.all %}
                                  <button>
                                    <i id="dlike-{{ director.pk }}" class="fa-solid fa-heart" style="color:red"></i>
                                  </button>
                                {% else %}
                                  <button>
                                    <i id="dlike-{{ director.pk }}" class="fa-solid fa-heart" style="color:black"></i>
                                  </button>
                                  {% endif %}
                                {% endif %}
                            </form>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <br>
                    <h4>배우</h4>
                    <hr>
                    <div class="d-flex flex-row justify-content-start fw-bold">
                        {% for actor in actors %}
                        {% if actor.movie_id == movie.id %}
                        <div class="d-flex">
                            <div class="item" style="margin:10px;">
                                <img  width="135px" src="https://www.themoviedb.org/t/p/original{{actor.profile_path}}" onerror="this.src=`{% static 'movies/ALT_IMAGE.png' %}`" alt="">
                                <div style="width:135px; text-align: center; word-break:normal;" class="text-center text-dark">{{actor.character}} 역</div>
                                <div style="width:135px; text-align: center; word-break:normal;" class="text-center text-dark">{{actor.name}}</div>
                                <!-- <div style="width:130px; text-align: center; word-break:normal;" class="text-center text-dark">{{actor.department}}</div> -->
                            </div>
                        </div>
                        {% if user.id %}
                        <div>
                            <form class="alike-form" data-actor-id="{{ actor.pk }}">
                                {% csrf_token %}
                                {% if user in actor.like_users.all %}
                                  <button>
                                    <i id="alike-{{ actor.pk }}" class="fa-solid fa-heart" style="color:red"></i>
                                  </button>
                                {% else %}
                                  <button>
                                    <i id="alike-{{ actor.pk }}" class="fa-solid fa-heart" style="color:black"></i>
                                  </button>
                                  {% endif %}
                                {% endif %}
                            </form>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
        {% if movie.user == request.user %}
        <div>
            <a href="{% url 'movies:update' movie.pk %}">UPDATE</a>
        </div>
        <form action="{% url 'movies:delete' movie.pk %}" method="POST">
            {% csrf_token %}
            <input type="submit" value="DELETE">
        </form>
            {% comment %} <a href="{% url 'movies:delete' movie.pk %}">DELETE</a> {% endcomment %}
        {% endif %}

        <hr>
        <h4>댓글</h4>
        <ul>
            {% for comment in comments %}
            <li>{{ comment.content }}
                {% if request.user == movie.user %}
                <form action="{% url 'movies:comments_delete' movie.pk comment.pk %}" method='POST' class='d-inline'>
                {% csrf_token %}
                <input type="submit" value="DELETE">
                </form>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        <hr>
        <form action="{% url 'movies:comments_create' movie.pk %}" method='POST'>
            {% csrf_token %}
            {{ comment_form }}
            <input type="submit" value='작성'>
        </form>
    </div>
    <br>
</div>
<script>
    const dforms = document.querySelectorAll('.dlike-form')
    const dcsrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    dforms.forEach((form) => {
        form.addEventListener('submit', (event)=>{
            event.preventDefault()
            const directorId = event.target.dataset.directorId
            axios({
                method: 'post',
                url: `http://127.0.0.1:8000/movies/${directorId}/director_likes/`,
                headers: {'X-CSRFToken': dcsrftoken},
            })
            .then(response => {
                const { isLiked, likedCount } = response.data
                const likeBtn = document.querySelector(`#dlike-${directorId}`)
                const likeCount = document.querySelector(`#dlike-count-${directorId}`)
                if (isLiked) {
                    likeBtn.style.color = 'red'
                } else {
                    likeBtn.style.color = 'black'
                }
            })
        })
    })
    const aforms = document.querySelectorAll('.alike-form')
    const acsrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    aforms.forEach((form) => {
        form.addEventListener('submit', (event)=>{
            event.preventDefault()
            const actorId = event.target.dataset.actorId
            axios({
                method: 'post',
                url: `http://127.0.0.1:8000/movies/${actorId}/actor_likes/`,
                headers: {'X-CSRFToken': acsrftoken},
            })
            .then(response => {
                const { isLiked, likedCount } = response.data
                const likeBtn = document.querySelector(`#alike-${actorId}`)
                const likeCount = document.querySelector(`#alike-count-${actorId}`)
                if (isLiked) {
                    likeBtn.style.color = 'red'
                } else {
                    likeBtn.style.color = 'black'
                }
            })
        })
    })
</script>
{% endblock detail %}